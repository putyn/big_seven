<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="Vlad Conut">
    <link rel="icon" href="img/favicon.ico">
    <title>Big Seven</title>
    <!-- build:css style.css -->
    <link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/bootstrap-theme.css" rel="stylesheet">
    <link href="css/bigseven.css" rel="stylesheet">
    <link href="css/roboto.css" rel="stylesheet">
    <link href="css/nprogress.css" rel="stylesheet">
    <!-- endbuild -->
</head>

<body>
    <!-- Fixed navbar -->
    <nav class="navbar navbar-default navbar-static-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="true" aria-controls="navbar"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="/">Big Seven</a> </div>
            <div id="navbar" class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="#wifi">WiFi Configuration</a> </li>
                    <li><a href="#time">Time Configuration</a> </li>
                    <li><a href="#fwupdate">Firmware Update</a> </li>
                </ul>
            </div>
            <!--/.nav-collapse -->
        </div>
    </nav>
    <!-- landing page (needs rework) -->
    <div class="container" id="content">
        <div class="row">
            <div class="col-md-8 col-md-offset-2">
                <div class="page-header">
                    <h4>Because reasons!</h4> </div> <strong>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer eleifend commodo porta. Fusce vitae odio purus. Nullam nisl velit, vehicula nec odio sed, commodo varius purus.</strong> </div>
        </div>
    </div>
    <!-- wifi container -->
    <div class="container hidden" id="content_wifi">
        <div class="row">
            <div class="col-md-8 col-md-offset-2">
                <div class="page-header">
                    <h4>WiFi Configuration</h4> </div>
                <label for="wifi_status">Overview</label>
                <ul class="list-group" id="wifi_status">
                    <!-- dynamically loaded -->
                </ul>
                <label for="available_networks">Available Wireless networks</label>
                <div class="list-group" id="available_networks">
                    <!-- dynamically loaded -->
                </div>
                <div class="form-group text-center hidden">
					<button type="button" class="btn btn-default" id="btn_refresh">Refresh list</button>
				</div>
                <!--modal for network-->
                <div class="modal fade" id="network_credentials" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <h4 class="modal-title" id="network_modal_title"></h4>
							</div>
                            <div class="modal-body">
								<div id="body_pre_request">
									<label for="network_password" class="control-label">Password:</label>
									<input type="hidden" class="form-control" id="network_ssid">
									<div class="input-group">
										<input type="password" class="form-control" id="network_password"><span class="input-group-addon glyphicon glyphicon-eye-open" id="btn_toggle_password"></span>
									</div>
								</div>
								<div class="hidden" id="body_post_request"></div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" id="btn_save">Save</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- wifi container end -->
    <!-- time container -->
    <div class="container hidden" id="content_time">
        <div class="row">
            <div class="col-md-8 col-md-offset-2">
                <div class="page-header">
                    <h4>Time configuration</h4>
				</div>
				<div class="form-group hidden" id="time_error">
				</div>
                <div class="form-group">
                    <label for="ntp_server">Time Server</label>
                    <input type="text" class="form-control" placeholder="ntp.pool.org" id="ntp_server" onclick="$(this).select()">
				</div>
                <div class="form-group">
                    <label for="time_zone">Time Zone</label>
                    <select class="form-control" id="time_zone">
                        <option value="-43200">UTC-12:00</option>
						<option value="-39600">UTC-11:00</option>
						<option value="-36000">UTC-10:00</option>
						<option value="-34200">UTC-09:30</option>
						<option value="-32400">UTC-09:00</option>
						<option value="-28800">UTC-08:00</option>
						<option value="-25200">UTC-07:00</option>
						<option value="-21600">UTC-06:00</option>
						<option value="-18000">UTC-05:00</option>
						<option value="-14400">UTC-04:00</option>
						<option value="-12600">UTC-03:30</option>
						<option value="-10800">UTC-03:00</option>
						<option value="-7200">UTC-02:00</option>
						<option value="-3600">UTC-01:00</option>
						<option value="0" selected>UTCÂ±00:00</option>
						<option value="+3600">UTC+01:00</option>
						<option value="+7200">UTC+02:00</option>
						<option value="+10800">UTC+03:00</option>
						<option value="+12600">UTC+03:30</option>
						<option value="+14400">UTC+04:00</option>
						<option value="+16200">UTC+04:30</option>
						<option value="+18000">UTC+05:00</option>
						<option value="+19800">UTC+05:30</option>
						<option value="+20700">UTC+05:45</option>
						<option value="+21600">UTC+06:00</option>
						<option value="+23400">UTC+06:30</option>
						<option value="+25200">UTC+07:00</option>
						<option value="+28800">UTC+08:00</option>
						<option value="+30600">UTC+08:30</option>
						<option value="+31500">UTC+08:45</option>
						<option value="+32400">UTC+09:00</option>
						<option value="+34200">UTC+09:30</option>
						<option value="+36000">UTC+10:00</option>
						<option value="+37800">UTC+10:30</option>
						<option value="+39600">UTC+11:00</option>
						<option value="+43200">UTC+12:00</option>
						<option value="+45900">UTC+12:45</option>
						<option value="+46800">UTC+13:00</option>
						<option value="+50400">UTC+14:00</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="time_dts">DST</label>
                    <select class="form-control" id="time_dst">
                        <option value="">---</option>
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                    </select>
                </div>
                <div class="form-group text-center">
					<button type="button" class="btn btn-default" id="btn_update">Update</button>
				</div>
            </div>
        </div>
    </div>
    <!-- time container end-->
    <!-- firmware update container -->
    <div class="container hidden" id="content_fwupdate">
        <div class="row">
            <div class="col-md-8 col-md-offset-2">
                <div class="page-header">
                    <h4>Firmware update</h4>
				</div>
				<strong>Not yet implemented! though its desired</strong>
			</div>
        </div>
    </div>	
    <!-- firmware update container end-->
    <footer class="footer">
        <div class="container">
            <p class="text-muted">&copy; Big Seven Ltd 2017</p>
        </div>
    </footer>
    <!-- build:js script.js -->
    <script src="js/jquery.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="js/nprogress.js"></script>
    <!-- endbuild -->
    <script>
		//pretty loading bar
		NProgress.configure({ 
			showSpinner: false
		});
        // A $( document ).ready() block.
        $(document).ready(function() {
			//nice loader
            console.log("Ready!");
			
            //check location for page
            var current_page = window.location.hash.replace("#", "");
            if (current_page) {
                //hide landing page
                $("div#content").addClass("hidden");
                //show correct page
                $("#content_" + current_page).removeClass("hidden");
                //activate link
                $("ul.navbar-nav > li > a[href*=" + current_page + "]").parent("li").addClass("active");
             
				//load page 
				load_page(current_page);
            }
			
            //bind menu change on click
            $("ul.navbar-nav > li > a").on("click", function() {
                //remove any active menu
                $("ul.navbar-nav > li").removeClass("active");
                //activate the current menu
                $(this).parent("li").addClass("active");
                //hide all contnet
                $("div[id*=content]").addClass("hidden");
                //show only needed content
                $("#content_" + $(this).attr("href").replace("#", "")).removeClass("hidden");
                //toggle navbar
                if ($(".navbar-toggle").is(":visible")) $(".navbar-toggle").click();
                //page load on click
                load_page($(this).attr("href").replace("#", ""));
            });
            //bind input password on ssid click
            $("#available_networks").on("click", "a[id!=network_credentials]", function() {
			
				//get network name from custom attr
                var ssid_name = $(this).attr("network-ssid");
				//change modal title
                $("#network_modal_title").html(ssid_name);
				//set value to hidden input
                $("#network_ssid").val(ssid_name);
				//reset value for password input 
                $("#network_password").val("");
				
				//reset modal content
				$("#body_post_request").hide();
				$("#body_pre_request").show();
				$("#btn_save").html("Save").show();
				if($("#btn_toggle_password").hasClass("glyphicon-eye-close"))
					$("#btn_toggle_password").click();
				
				//show modal with keyboard (on mobile)
                $("#network_credentials").modal({
                    'keyboard': true
                });
            });
			//bind connect button 
			$("#network_credentials").on("click", "button#btn_save", function(e) {
				//pretty progress bar
				NProgress.start();
				$(this).html("Please wait...");
				
				//get ssid and network from inputs
				var network_password = $("#network_password").val();
				var network_ssid = $("#network_ssid").val();
				
				//make them requests
				$.post('/wifi', {ssid: network_ssid, pass: network_password }, function (data) {
					//hide password input in modal
					$("#body_pre_request").hide();
					//present some pretty error messages to the user
					if(data.error) {
						$("#body_post_request").html("<div class=\"list-group\"><div class=\"list-group-item list-group-item-warning\"><strong>Fool!</strong> "+data.message+"</div></div>").removeClass("hidden").show();
						$("#btn_save").hide();
					} else {
						$("#body_post_request").html("<div class=\"list-group\"><div class=\"list-group-item list-group-item-success\">Settings saved for network <strong>"+network_ssid+"</strong>, after rebooting connect to the same network to configure the device!</div></div>").removeClass("hidden").show();
						$("#btn_save").html("Reboot");
						
						//rebind button
						$("#btn_save").off().on("click", function() {
							location.href = "/reboot";
							//location.reload();
						});
					}
				}, "json").fail( function(xhr, status, error) {
					//hide password input in modal
					$("#body_pre_request").hide();
					//prepare error message, make it pretty show it
					$("#body_post_request").html("<div class=\"list-group\"><div class=\"list-group-item list-group-item-danger\">Something went wrong with the last request - <strong>"+xhr.status+" (" + error + ")</strong></div></div>").removeClass("hidden").show();
					//hide the connect button
					$("#btn_connect").hide();
				}).always(function () {
					NProgress.done();
				});
			});
			//bind time uppdate button
			$("#content_time").on("click", "button#btn_update", function (e) {
				//pretty progress bar
				NProgress.start();
				
				//get values
				var  ntp_server_val = $("#ntp_server").val();
				var  time_zone_val = $("#time_zone").val();
				var  time_dst_val = $("#time_dst").val();
				
				$.post("/time", {ntp_server: ntp_server_val, time_zone: time_zone_val, time_dst: time_dst_val}, function(data) {
				
					//pretty messages
					if(data.error) {
						$("#time_error").html("<div class=\"alert alert-warning\">Couldn't update the configuration <strong>"+data.message +"</strong></div>").removeClass("hidden");
					} else {
						$("#time_error").html("<div class=\"alert alert-success\">Configuration updated sucessfully").removeClass("hidden");
						//update page
						$("#ntp_server").val(data.ntp_server);
						$("#time_zone option[value='"+data.time_zone+"']").prop("selected", true);
						$("#time_dst option[value='"+data.time_dst+"']").prop("selected", true);
					}
				}, "json").fail( function(xhr, status, error) {
					$("#time_error").html("<div class=\"alert alert-danger\">Something went wrong with the last request - <strong>"+xhr.status+" (" + error + ")</strong></div>").removeClass("hidden");
				}).always( function () {
						NProgress.done();
				});
				//debug info
				console.log(ntp_server_val + ", " + time_zone_val + ", " + time_dst_val  );
			});
			//on modal show focus the password input
            $("#network_credentials").on("shown.bs.modal", function() {					
                $("#network_password").focus();
            });
            //bind refresh of page on button click
            $("#btn_refresh").on("click", function() {
                location.reload();
            });
            //toggle password
            $("#btn_toggle_password").on("click", function() {
                if ($(this).hasClass("glyphicon-eye-open")) {
                    $(this).removeClass("glyphicon-eye-open").addClass("glyphicon-eye-close");
                    $("#network_password").attr("type", "text");
                } else {
                    $(this).removeClass("glyphicon-eye-close").addClass("glyphicon-eye-open");
                    $("#network_password").attr("type", "password");
                }
            });
        });

        function load_page(page) {
			//pretty loading bar
			NProgress.start();
            console.log("loading page - " + (page.length > 0 ? page : "index"));
            switch (page) {
                case 'wifi':
                    $.getJSON("/wifi", function(data) {
                        var status_items = [];
                        $.each(data["status"], function(item_name, item_value) {
                            status_items.push("<li class=\"list-group-item\"><strong>" + item_name + ":</strong> " + item_value + "</li>");
                        });
						//update wifi status
                        $("#wifi_status").html(status_items.join(""));
						//show refresh button
						$("#btn_refresh").parent().removeClass("hidden");
						//go throw the networks 
                        if (data["networks"].length > 0) {
                            var network_items = [];
							//sort data by qual
							data["networks"] = sortByKey(data["networks"], "quality");
							
                            $.each(data["networks"], function(item_key, item_value) {
                                network_items.push("<a class=\"list-group-item\" network-ssid=\"" + item_value.ssid + "\">" + item_value.ssid);
                                if (item_value.auth) network_items.push("<span class=\"glyphicon glyphicon-lock pull-right\"></span>");
                                network_items.push("</a>");
                            });
                            $("label[for='available_networks']").removeClass("hidden");
                            $("#available_networks").removeClass("hidden").html(network_items.join(""));
                        } else {
                            $("#available_networks").html("<div class=\"list-group-item list-group-item-warning\">Scan not finished or no network available</div>");
                        }
                    }).fail(function(xhr, status, error) {
                        $("#wifi_status").html("<li class=\"list-group-item list-group-item-danger\">Something went wrong with the last request - <strong>"+xhr.status+" (" + error + ")</strong></li>");
                        $("#available_networks").html("<li class=\"list-group-item list-group-item-danger\">Something went wrong with the last request - <strong>"+xhr.status+" (" + error + ")</strong></li>");
                    }).always( function () {
						NProgress.done();
					});
                    break;
                case 'time':
					$.getJSON("/time", function(data) {
						$("#time_error").addClass("hidden");
						$("#ntp_server").val(data.ntp_server);
						$("#time_zone option[value='"+data.time_zone+"']").prop("selected", true);
						$("#time_dst option[value='"+data.time_dst+"']").prop("selected", true);					
					}).fail(function(xhr, status, error) {
						$("#time_error").html("<div class=\"alert alert-danger\">Something went wrong with the last request - <strong>"+xhr.status+" (" + error + ")</strong></div>").removeClass("hidden");
					}).always( function () {
						NProgress.done();
					});
                    break;
                case 'fwupdate':
					NProgress.done();
                    break;
            }
			//stackoverflow http://stackoverflow.com/a/8175221
			function sortByKey(array, key) {
				return array.sort(function(a, b) {
					var x = a[key]; var y = b[key];
						return ((x > y) ? -1 : ((x < y) ? 1 : 0));
				});
			}
        }
    </script>
</body>
</html>